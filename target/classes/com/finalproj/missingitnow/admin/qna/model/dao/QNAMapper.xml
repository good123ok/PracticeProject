<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.finalproj.missingitnow.admin.qna.model.dao.QNAMapper">
	<resultMap type="qnaDTO" id="QNAResultSet">
		<id column="QNA_NO" property="no"/>
		<result column="USER_NO" property="userNo"/>
		<result column="QNA_TITLE" property="title"/>
		<result column="QNA_DETAILS" property="details"/>
		<result column="QNA_DATE" property="date"/>
		<result column="QNA_REPLY" property="reply"/>
		<result column="QNA_REPLY_DATE" property="replyDate"/>
		<result column="QNA_REPLY_CHK" property="replyChk"/>
		<result column="QNA_STATUS" property="status"/>
		<association property="user" resultMap="UserResultSet"/>
	</resultMap>
	<resultMap type="userDTO" id="UserResultSet">
		<id column="USER_NO" property="no"/>
		<result column="USER_ID" property="id"/>
		<result column="USER_NAME" property="name"/>
		<result column="USER_BIRTH" property="birth"/>
		<result column="USER_ADDRESS" property="address"/>
		<result column="USER_CONTACTS" property="contacts"/>
		<result column="USER_EMAIL" property="email"/>
		<result column="USER_REGST_DATE" property="registDate"/>
	</resultMap>
	<select id="selectTotalCount" resultType="_int">
	    SELECT
	           COUNT(*)
	      FROM TBL_QNA A
	     WHERE A.QNA_STATUS = 'Y'
	</select>
	<select id="selectSearchTotalCount" resultType="_int">
	    SELECT
	           COUNT(*)
	      FROM TBL_QNA A
	      JOIN TBL_USER B ON(A.USER_NO = B.USER_NO)
	     <trim prefix="WHERE" prefixOverrides="AND | OR">
             <choose>
	             <when test="largeSearchCondition == 'answer'">
	             	 <choose>
			             <when test="smallSearchCondition == 'id'">
							B.USER_ID LIKE '%' || #{ searchValue } || '%'
						 </when>
						 <when test="smallSearchCondition == 'name'">
							B.USER_NAME LIKE '%' || #{ searchValue } || '%'
						 </when>
						 <when test="smallSearchCondition == 'title'">
							A.QNA_TITLE LIKE '%' || #{ searchValue } || '%'
						 </when>
					 </choose>
					 AND A.QNA_REPLY_CHK = 'Y'
					 <choose>
			             <when test="searchWriteDateStart != null and searchWriteDateEnd == null">
							<![CDATA[
								AND A.QNA_DATE >= #{ searchWriteDateStart }
							]]>
						 </when>
						 <when test="searchWriteDateStart == null and searchWriteDateEnd != null">
						 	<![CDATA[
								AND A.QNA_DATE <= #{ searchWriteDateEnd }
							]]>
						 </when>
						 <when test="searchWriteDateStart != null and searchWriteDateEnd != null">
							AND A.QNA_DATE BETWEEN #{ searchWriteDateStart } AND #{ searchWriteDateEnd }
						 </when>
					 </choose>
	             </when>
	             <when test="largeSearchCondition == 'noneAnswer'">
		             <choose>
			             <when test="smallSearchCondition == 'id'">
							B.USER_ID LIKE '%' || #{ searchValue } || '%'
						 </when>
						 <when test="smallSearchCondition == 'name'">
							B.USER_NAME LIKE '%' || #{ searchValue } || '%'
						 </when>
						 <when test="smallSearchCondition == 'title'">
							A.QNA_TITLE LIKE '%' || #{ searchValue } || '%'
						 </when>
					 </choose>
					 AND A.QNA_REPLY_CHK = 'N'
					 <choose>
			             <when test="searchWriteDateStart != null and searchWriteDateEnd == null">
							<![CDATA[
								AND A.QNA_DATE >= #{ searchWriteDateStart }
							]]>
						 </when>
						 <when test="searchWriteDateStart == null and searchWriteDateEnd != null">
						 	<![CDATA[
								AND A.QNA_DATE <= #{ searchWriteDateEnd }
							]]>
						 </when>
						 <when test="searchWriteDateStart != null and searchWriteDateEnd != null">
							AND A.QNA_DATE BETWEEN #{ searchWriteDateStart } AND #{ searchWriteDateEnd }
						 </when>
					 </choose>
	             </when>
	             <otherwise>
		             <choose>
			             <when test="smallSearchCondition == 'id'">
							B.USER_ID LIKE '%' || #{ searchValue } || '%'
						 </when>
						 <when test="smallSearchCondition == 'name'">
							B.USER_NAME LIKE '%' || #{ searchValue } || '%'
						 </when>
						 <when test="smallSearchCondition == 'title'">
							A.QNA_TITLE LIKE '%' || #{ searchValue } || '%'
						 </when>
					 </choose>
					 <choose>
			             <when test="searchWriteDateStart != null and searchWriteDateEnd == null">
							<![CDATA[
								AND A.QNA_DATE >= #{ searchWriteDateStart }
							]]>
						 </when>
						 <when test="searchWriteDateStart == null and searchWriteDateEnd != null">
						 	<![CDATA[
								AND A.QNA_DATE <= #{ searchWriteDateEnd }
							]]>
						 </when>
						 <when test="searchWriteDateStart != null and searchWriteDateEnd != null">
							AND A.QNA_DATE BETWEEN #{ searchWriteDateStart } AND #{ searchWriteDateEnd }
						 </when>
					 </choose>
	             </otherwise>
             </choose>
             AND A.QNA_STATUS = 'Y'
         </trim>
	</select>
	<select id="selectList" resultMap="QNAResultSet" >
	    SELECT
	           A.RNUM
	         , A.QNA_NO
	         , A.USER_NO
	         , A.USER_NAME
	         , A.QNA_TITLE
	         , A.QNA_DETAILS
	         , A.QNA_DATE
	         , A.QNA_REPLY
	         , A.QNA_REPLY_DATE
	         , A.QNA_REPLY_CHK
	         , A.QNA_STATUS
	      FROM (SELECT ROWNUM RNUM
	                 , B.QNA_NO
	                 , B.USER_NO
	                 , B.USER_NAME
	                 , B.QNA_TITLE
	                 , B.QNA_DETAILS
	                 , B.QNA_DATE
	                 , B.QNA_REPLY
	                 , B.QNA_REPLY_DATE
	                 , B.QNA_REPLY_CHK
	                 , B.QNA_STATUS
	              FROM ( SELECT C.QNA_NO
	                          , C.USER_NO
	                          , D.USER_NAME
	                          , C.QNA_TITLE
	                          , C.QNA_DETAILS
	                          , C.QNA_DATE
	                          , C.QNA_REPLY
	                          , C.QNA_REPLY_DATE
	                          , C.QNA_REPLY_CHK
	                          , C.QNA_STATUS
	                       FROM TBL_QNA C
	                       JOIN TBL_USER D ON(C.USER_NO = D.USER_NO)
	                      WHERE C.QNA_STATUS = 'Y'
	                      ORDER BY TO_NUMBER(C.QNA_NO) DESC
	                   )B
	             <choose>
	             <when test="searchCondition == 'writer'">
					WHERE B.USER_NAME LIKE '%' || #{ searchValue } || '%'
				 </when> 
				 <when test="searchCondition == 'title'">
					WHERE B.QNA_TITLE LIKE '%' || #{ searchValue } || '%'
				 </when>
				 <when test="searchCondition == 'titleAndBody'">
					WHERE B.QNA_TITLE LIKE '%' || #{ searchValue } || '%'
					   OR B.QNA_DETAILS LIKE '%' || #{ searchValue } || '%'
				 </when>
				 <otherwise>
				 	WHERE B.QNA_DETAILS LIKE '%' || #{ searchValue } || '%'
				 </otherwise>
				 </choose>
	           ) A
	     WHERE A.RNUM BETWEEN #{ pageInfo.startRow } AND #{ pageInfo.endRow }
	</select>
	<insert id="insertQNA">
	    INSERT
	      INTO TBL_QNA A
	    (
	      A.QNA_NO
	       , A.USER_NO
	       , A.QNA_TITLE
	       , A.QNA_DETAILS
	       , A.QNA_DATE
	       , A.QNA_REPLY
	       , A.QNA_REPLY_DATE
	       , A.QNA_REPLY_CHK
	       , A.QNA_STATUS
	    )
	    VALUES
	    (
	      SEQ_QNA.NEXTVAL
	    , 1
	    , #{ title }
	    , #{ details }
	    , SYSDATE
	    , NULL
	    , NULL
	    , DEFAULT
	    , DEFAULT
	    )
	</insert>	
	<select id="selectAllList" resultMap="QNAResultSet" >
	    SELECT
	           A.RNUM
	         , A.QNA_NO
	         , A.USER_NO
	         , A.USER_NAME
	         , A.USER_ID
	         , A.QNA_TITLE
	         , A.QNA_DETAILS
	         , A.QNA_DATE
	         , A.QNA_REPLY
	         , A.QNA_REPLY_DATE
	         , A.QNA_REPLY_CHK
	         , A.QNA_STATUS
	      FROM (SELECT ROWNUM RNUM
	                 , B.QNA_NO
	                 , B.USER_NO
	                 , B.USER_NAME
	                 , B.USER_ID
	                 , B.QNA_TITLE
	                 , B.QNA_DETAILS
	                 , B.QNA_DATE
	                 , B.QNA_REPLY
	                 , B.QNA_REPLY_DATE
	                 , B.QNA_REPLY_CHK
	                 , B.QNA_STATUS
	              FROM ( SELECT C.QNA_NO
	                          , C.USER_NO
	                          , D.USER_NAME
	                          , D.USER_ID
	                          , C.QNA_TITLE
	                          , C.QNA_DETAILS
	                          , C.QNA_DATE
	                          , C.QNA_REPLY
	                          , C.QNA_REPLY_DATE
	                          , C.QNA_REPLY_CHK
	                          , C.QNA_STATUS
	                       FROM TBL_QNA C
	                       JOIN TBL_USER D ON(C.USER_NO = D.USER_NO)
	                      WHERE C.QNA_STATUS = 'Y'
	                      ORDER BY TO_NUMBER(C.QNA_NO) DESC
	                   )B
	             <trim prefix="WHERE" prefixOverrides="AND | OR">
		             <choose>
			             <when test="largeSearchCondition == 'answer'">
			             	 <choose>
					             <when test="smallSearchCondition == 'id'">
									B.USER_ID LIKE '%' || #{ searchValue } || '%'
								 </when>
								 <when test="smallSearchCondition == 'name'">
									B.USER_NAME LIKE '%' || #{ searchValue } || '%'
								 </when>
								 <when test="smallSearchCondition == 'title'">
									B.QNA_TITLE LIKE '%' || #{ searchValue } || '%'
								 </when>
							 </choose>
							 AND B.QNA_REPLY_CHK = 'Y'
							 <choose>
					             <when test="searchWriteDateStart != null and searchWriteDateEnd == null">
									<![CDATA[
										AND B.QNA_DATE >= #{ searchWriteDateStart }
									]]>
								 </when>
								 <when test="searchWriteDateStart == null and searchWriteDateEnd != null">
								 	<![CDATA[
										AND B.QNA_DATE <= #{ searchWriteDateEnd }
									]]>
								 </when>
								 <when test="searchWriteDateStart != null and searchWriteDateEnd != null">
									AND B.QNA_DATE BETWEEN #{ searchWriteDateStart } AND #{ searchWriteDateEnd }
								 </when>
							 </choose>
			             </when>
			             <when test="largeSearchCondition == 'noneAnswer'">
				             <choose>
					             <when test="smallSearchCondition == 'id'">
									B.USER_ID LIKE '%' || #{ searchValue } || '%'
								 </when>
								 <when test="smallSearchCondition == 'name'">
									B.USER_NAME LIKE '%' || #{ searchValue } || '%'
								 </when>
								 <when test="smallSearchCondition == 'title'">
									B.QNA_TITLE LIKE '%' || #{ searchValue } || '%'
								 </when>
							 </choose>
							 AND B.QNA_REPLY_CHK = 'N'
							 <choose>
					             <when test="searchWriteDateStart != null and searchWriteDateEnd == null">
									<![CDATA[
										AND B.QNA_DATE >= #{ searchWriteDateStart }
									]]>
								 </when>
								 <when test="searchWriteDateStart == null and searchWriteDateEnd != null">
								 	<![CDATA[
										AND B.QNA_DATE <= #{ searchWriteDateEnd }
									]]>
								 </when>
								 <when test="searchWriteDateStart != null and searchWriteDateEnd != null">
									AND B.QNA_DATE BETWEEN #{ searchWriteDateStart } AND #{ searchWriteDateEnd }
								 </when>
							 </choose>
			             </when>
			             <otherwise>
				             <choose>
					             <when test="smallSearchCondition == 'id'">
									B.USER_ID LIKE '%' || #{ searchValue } || '%'
								 </when>
								 <when test="smallSearchCondition == 'name'">
									B.USER_NAME LIKE '%' || #{ searchValue } || '%'
								 </when>
								 <when test="smallSearchCondition == 'title'">
									B.QNA_TITLE LIKE '%' || #{ searchValue } || '%'
								 </when>
							 </choose>
							 <choose>
					             <when test="searchWriteDateStart != null and searchWriteDateEnd == null">
									<![CDATA[
										AND B.QNA_DATE >= #{ searchWriteDateStart }
									]]>
								 </when>
								 <when test="searchWriteDateStart == null and searchWriteDateEnd != null">
								 	<![CDATA[
										AND B.QNA_DATE <= #{ searchWriteDateEnd }
									]]>
								 </when>
								 <when test="searchWriteDateStart != null and searchWriteDateEnd != null">
									AND B.QNA_DATE BETWEEN #{ searchWriteDateStart } AND #{ searchWriteDateEnd }
								 </when>
							 </choose>
			             </otherwise>
		             </choose>
		         </trim>
	           ) A
	     WHERE A.RNUM BETWEEN #{ pageInfo.startRow } AND #{ pageInfo.endRow }
	</select>
	<update id="increamentBoardCount" parameterType="_int">
	    UPDATE
	           TBL_QNA A
	       SET A.QNA_HITS = (SELECT B.QNA_HITS + 1
	                        FROM TBL_QNA B
	                       WHERE B.QNA_NO = #{ no }
	                     )
	    WHERE A.QNA_NO = #{ no }
	</update>
	<select id="selectDetail" parameterType="_int" resultMap="QNAResultSet">
	    SELECT
	           A.QNA_NO
	         , B.USER_NO
	         , B.USER_NAME
	         , A.QNA_TITLE
	         , A.QNA_DETAILS
	         , A.QNA_DATE
	         , A.QNA_REPLY
	         , A.QNA_REPLY_DATE
	         , A.QNA_REPLY_CHK
	         , A.QNA_STATUS
	      FROM TBL_QNA A
	      JOIN TBL_USER B ON(A.USER_NO = B.USER_NO)
	     WHERE A.QNA_NO = #{ no }
	       AND A.QNA_STATUS = 'Y'
	</select>
	<update id="updateQNA" parameterType="qnaDTO">
	    UPDATE
	           TBL_QNA A
	       SET A.QNA_TITLE = #{ title }
	         , A.QNA_DETAILS = #{ details }
	     WHERE A.QNA_NO = #{ no }
	       AND A.QNA_STATUS = 'Y'
	</update>
	<update id="deleteQNA" parameterType="_int">
	    UPDATE
	           TBL_QNA A
	       SET A.QNA_STATUS = 'N'
	     WHERE A.QNA_NO = #{ no }
	       AND A.QNA_STATUS = 'Y'
	</update>
	<update id="updateResponse" parameterType="qnaDTO">
	    UPDATE
	           TBL_QNA A
	       SET A.QNA_REPLY = #{ reply }
	         , A.QNA_REPLY_DATE = SYSDATE
	     WHERE A.QNA_NO = #{ no }
	       AND A.QNA_REPLY IS NULL
	</update>
	<update id="updateReplyCheck" parameterType="qnaDTO">
	    UPDATE
	           TBL_QNA A
	       SET A.QNA_REPLY_CHK = 'Y'
	     WHERE A.QNA_NO = #{ no }
	       AND A.QNA_REPLY_CHK = 'N'
	</update>
</mapper>